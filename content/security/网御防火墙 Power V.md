---
2022-08-01 20:02:29
---

# 网御防火墙 Power V

- [网御防火墙 Power V](#网御防火墙-power-v)
  - [快速配置使用安全网关](#快速配置使用安全网关)
  - [Web 界面操作手册](#web-界面操作手册)
    - [如何开始](#如何开始)
    - [规则配置](#规则配置)
    - [资源管理](#资源管理)
    - [网络配置](#网络配置)
    - [设备参数管理](#设备参数管理)
    - [状态监控](#状态监控)
    - [维护工具](#维护工具)
    - [辅助功能](#辅助功能)
    - [VPN 配置](#vpn-配置)
  - [功能使用手册](#功能使用手册)
    - [VPN 概念与配置方法](#vpn-概念与配置方法)
    - [HA 概念与配置方法](#ha-概念与配置方法)
    - [用户认证概念与配置方法](#用户认证概念与配置方法)
    - [冗余设备概念与配置方法](#冗余设备概念与配置方法)
    - [深度过滤概念与配置方法](#深度过滤概念与配置方法)
    - [典型应用环境](#典型应用环境)
    - [FAQ](#faq)

## 快速配置使用安全网关

- 配置使用
    1. 通过 Web 浏览器配置管理安全网关设备
        - `基本过程：配置管理主机➡️安装usb钥匙并认证管理员身份➡️配置管理`
        - `切记：安装驱动前不要插入 USB 电子钥匙`
        - 利用随机附带的网线直接连接管理主机网口和安全网关 fe1 网口（初始配置，只能将管理主机连接在安全网关的第一个网口上），把管理主机 IP 设置为 `10.1.5.200`，掩码为 `255.255.255.0`。在管理主机运行 `ping 10.1.5.254` 验证是否真正连通，如不能连通，检查管理主机的 `IP（10.1.5.200）`是否设置在与安全网关相连的网络接口上，强烈建议该网口不要绑定其他 IP，也不要通过交换机连接安全网关。
        - 运行 administrator 目录中的 ikeyc 程序，提示输入用户 pin，输入 `12345678`即可。
        - 运行 IE 浏览器，在地址栏输入 `https://10.1.5.254:8888`。系统将提示输入用户名和密码，缺省都是 `administrator`。
        - 安全网关网络配置
            - 透明方式，以 fe3 和 fe4 为例：
                1. 网络配置➡️接口管理➡️物理设备，点击 fe3 对应的操作按钮进行编辑，`如果该接口连接交换机的 trunk 口且交换机划分多个 vlan，选择开启 trunk 功能，最后选择启用设备。`
            - 路由模式，以 fe3 和 fe4 为例：
                2. 如果希望安全网关能上互联网，还需要给安全网关配置缺省路由。进入网络配置➡️路由管理➡️静态路由➡️添加，目标地址：`0.0.0.0`，掩码：`0.0.0.0`， 下一跳地址输入缺省网关地址，网络接口：输入与缺省网关直接相连的网口设备。
        - 配置安全策略
            - `系统缺省包过滤策略是允许`，因此在缺省情况下安全网关就可以正常转发网络数据。可以通过配置安全选项改变缺省策略，具体是：`进入规则配置➡️包过滤规则➡️规则配置，取消“包过滤缺省允许”`。
            - 如果希望对指定地址、服务限制访问或进行地址转换，您必须自定义安全规则，详细请参阅`WEB 界面在线手册第一章“规则配置”`。
    2. 通过串口配置管理安全网关设备
        - `基本步骤：连接串口线➡️配置超级终端➡️配置管理`
        - 登录安全网关。当安全网关提示输入用户名和密码时，输入 `administrator` 和 `administrator`，所有的字母都是小写的。
        - 安全网关网络配置。按安全网关接入方式主要分两种情况：
            - 透明方式，以 fe3 和 fe4 为例：

            ```cmd
            # 如果 fe3 连接交换机 trunk 口而且交换机划分多个 vlan，增加 trunk on 参数。
            interface set phy if fe3 workmode trans active on
            ```

            - 路由模式， 以 fe3 和 fe4 为例：

            ```cmd
            # 如果 fe3 连接交换机 trunk 口而且交换机划分多个 vlan，增加 trunk on 参数。
            # 如何希望该接口可以响应 icmp 请求，增加 ping on 参数。
            # 如何希望该接口可以用于 Web 管理，增加 admin on 参数。
            interface set phy if fe3 ip 1.1.1.1 netmask 255.255.255.0 workmode route active on
            # 如果希望安全网关能上互联网，还需要给安全网关配置缺省路由。
            route add static dip 0.0.0.0/255.255.255.0 gateway 1.1.1.254 interface fe3 
            ```

        - 配置安全策略
            - `option set filter_policy deny`

## Web 界面操作手册

### 如何开始

- 登录管理界面
  - 登录方法
    - SSH 登录管理必须首先在`设备参数管理➡️管理方式`中设置 SSH 登录，才可以通过 SSH 协议远程登录安全网关。
  - 管理认证
    - 使用管理证书认证方式，必须在先使用电子钥匙登录安全网关，上载安全网关证书后，并且在 IE 导入管理员证书后，可通过登录 `https://10.1.5.254:8889` 管理安全网关了。
  - `网御安全网关 Power V 的一般配置过程`
    - 以 Web 界面管理方式为例，配置安全网关一般遵循以下步骤：
            1. 登录管理界面
            2. 选择`资源管理`菜单项中的子项，定义地址，服务，用户，时间，带宽，需要过滤的 URL，网络环境中存在的 VLAN ID 等资源。
            3. 选择`网络配置➡️接口管理➡️物理设备`，修改网口的工作模式和 IP 地址。选择`设备参数管理➡️管理主机`，修改管理主机的 IP 地址配置。如果网络环境复杂，还需要配置`网络配置➡️接口管理`下的 VLAN 设备，桥接设备，别名设备和 VPN 设备。
            4. 选择`规则配置`，设置相应的包过滤，NAT，端口映射和 IP 映射规则。其中包过滤规则中包含了设置 IPSec，用户认证，代理的规则。NAT 规则中包含了源地址转换和伪装的功能。源地址转换可以明确设定源地址转换成安全网关设备地址和地址池地址。
            5. 系统保存，单击上侧中部磁盘的图标，保存系统配置。如果没有保存就重新启动，系统将恢复到上一次保存的配置。
            6. 在日常的维护中，经常观察安全网关`状态监控`菜单下的内容和日志服务器中的日志信息，以便了解安全网关的工作状态。

### 规则配置

- 包顾虑规则
  - 安全选项
    - `安全选项提供安全网关可设置的一些全局安全策略，包括包过滤策略、抗攻击策略、IP/MAC 检查开关和是否允许除 IP 和 ARP 之外的其他非 IP 协议通过。这些参数对整个安全网关生效。`
  - 规则配置
    ![网御安全网关PowerV包过滤规则配置项说明](https://i.imgur.com/2IryDLR.jpg)
- 代理服务
  - 规则配置
    - `其中的 HTTP 代理，FTP 代理，Telnet 代理，POP3 代理是透明的代理规则`，即源地址/目的地址之间的信息会自动地由运行在安全网关上的代理程序转发，所以在客户端浏览网页时不必指定所使用的代理服务器（即安全网关）地址。其它代理都需要在客户端上指定代理服务器的地址。
    - `代理规则优先于包过滤规则，如果配置了代理规则，就意味着地址、端口、协议完全相同的包过滤规则失去了作用。所以在配置代理规则时请考虑安全网关整体的安全策略。`
- NAT 规则
  - `设置一条 NAT 规则，必须再设置一条相应的包过滤规则才能生效。方法如下：包过滤规则的源地址是 NAT 规则的源地址，包过滤规则的目的地址是 NAT 规则的目的地址。`
  - `在透明模式下选择伪装必须给桥设备配置同网段 IP 地址。如果目的地址不是同网段地址，还必须给系统配置相应的路由信息，并且此路由必须基于桥设备，否则无法完成伪装，只能使用源地址转换功能，指定转换后的地址。`
- 端口映射规则
  - `设置一条端口映射规则，如果没有选择“包过滤缺省策略通过”，还必须再设置一条相应的包过滤规则才能生效。方法如下：包过滤规则的源地址是端口映射的源地址，包过滤规则的目的地址是端口映射规则的内部地址。服务是端口映射规则的内部服务。`
- IP 映射规则
  - `设置一条 IP 映射规则，如果没有选择“包过滤缺省策略通过”，还必须再设置一条相应的包过滤规则才能生效。方法如下：包过滤规则的源地址是 IP 映射规则的源地址，包过滤规则的目的地址是 IP 映射规则的内部地址。`
  - `IP 映射规则和端口映射规则属于目的地址转换。它们的区别是：端口映射只对指定端口的连接做地址转换，而 IP 映射对特定 IP 地址的所有端口都做转换。`
- 地址绑定
- 带宽管理
- 黑名单
  - `黑名单与包过滤规则的不同之处在于：`
        1. 黑名单阻断优先于包过滤规则；
        2. 被包过滤拒绝的源地址请求连接时会被拒绝，但是如果未启用规则优先的安全选项，则添加规则前已建立的连接不会被中断；而黑名单上的地址，无论下规则前是否已建立连接，都会被立即阻断。
  - `黑名单规则添加后不能修改，如果需要修改，请删除旧规则，增加一条新的规则。`
- 连接管理
  - 入侵检测模块主要功能特点包括：
    - `实时网络数据流监控`
    - `网络攻击模式匹配`
    - `针对入侵行为的实时自动响应`
    - `灵活的检测策略设置`
    - `支持用户添加自定义检测规则`
    - `支持高级用户调整检测规则`
    - `全天候报警方式`

### 资源管理

- 网御安全网关系统可以定义以下资源：
  - 地址：地址、地址组、NAT 地址池、服务器地址、域名地址
  - 服务：服务、服务组
  - 用户：用户、用户组
  - 时间：时间、时间组、一次性调度和周循环调度
  - 带宽：带宽
  - 深度过滤：url 组、关键字组、文件名组、邮件地址组、蠕虫过滤、过滤策略、基本配置
  - VLAN ID
- 地址资源
  - 地址列表
    - 可以按三种方式来定义地址：
            1. IP 地址/掩码
            2. 反 IP 地址/掩码
            3. 地址范围 IP1 - IP2
  - 地址组
  - 地址池
    - `地址池`用于定义地址映射时的 ip 地址段
    - `一个 NAT 地址池最多支持 254 个 IP 地址，IP 地址不能跨网段，计算时，A 类地址掩码为 255.0.0.0，B 类地址掩码为 255.255.0.0，C 类地址掩码为 255.255.255.0`
    - 这里定义的地址池只是定义了一个地址的资源，必须在别名设备配置中创建了对应的别名设备后，才可以使引用地址池的 NAT 地址转换规则起到地址转换的作用。
  - 服务器地址
    - `服务器地址`用于指定一组内部服务器地址
  - 域名地址
    - `域名地址`是使用域名做为安全规则中源地址和目的地址的选项
- 服务资源
  - 服务用于指定 “协议 + 源端口 + 目的端口”，可以定义四种服务：
    - 动态服务：目前支持 H323、FTP、SQLNET、IRC、PPTP、RSTP、TFTP 等动态协议
    - ICMP 服务：可指定 type 和 code
    - 基本服务：可以“协议 + 源端口 + 目的端口”
    - 服务组：把以上服务组合起来，形成一个服务组。
  - `以下两处用到服务资源`
    - `策略配置`下的：包过滤规则、NAT 规则、端口映射规则
    - `资源管理`下的：用户、用户组
- 用户资源
  - 用户认证与`规则配置➡️包过滤规则➡️规则配置`配合使用，在安全规则中选择“认证用户组”，则此连接必须需要经过认证，才能被“允许”。其它的规则（IP 映射规则，端口映射规则和 NAT 规则）如果需要进行用户认证，只能依赖相应的包过滤规则来实现。
  - 认证服务器在`辅助功能➡️联动➡️用户认证服务器`中设置，支持两种认证方式：
    - RADIUS 认证
    - 本地认证
  - `在此“资源管理”➡️“用户资源”界面中定义的用户和用户组均为本地用户认证库，只能为本地认证使用。`
- 时间资源
  - 定义的时间和时间组在以下几处应用：
        1. 安全规则：包过滤规则、NAT 规则、端口映射规则、IP 映射规则
        2. 本地用户认证：用户、用户组的安全策略和可使用的服务
        3. 拨号设备中设置自动拨号
- 带宽资源
  - 可以定义三种类型的带宽资源，`非共享带宽，共享带宽和带宽资源组`，只有先定义了非共享带宽后，才可以定义共享带宽，而带宽资源组是不同接口下的共享带宽的组合。
- 深度过滤
  - 使用深度过滤功能，需要在`资源管理➡️深度过滤`定义深度过滤资源。首先，在`资源管理➡️深度过滤➡️基本配置`启用深度过滤，然后定义 URL 组、关键字组、文件名组、邮件地址组等预先定义的资源，之后定义深度过滤策略，根据起用的功能点，选择不同的预先定义的资源，同时设置是否记录日志等选项。
- VLAN ID

### 网络配置

- 接口管理
  - 网御安全网关 Power V 可配置的网络设备有：`物理设备，VLAN 设备，桥接设备，VPN 设备，别名设备，冗余设备和拨号设备`。
    - 物理设备：安全网关中实际存在的网口设备，不能删除，也不能添加。
    - VLAN 设备：是一种在物理设备基础上创建的设备。`与交换机的 TRUNK 口相连的安全网关物理设备上可以创建 VLAN 设备，以实现不同 VLAN 之间的互联。它可以工作在路由模式下，也可以工作在透明模式下。同一个物理设备上可以创建 VLAN ID 为 0 至 4094 的 VLAN 设备。同一物理设备上创建的不同 VLAN 设备，VLAN ID 必须不同，用于接收和发送带有相应 VLAN ID 的数据包。不同物理设备上创建的 VLAN 设备的 VLAN ID 可以相同。`
    - 桥接设备：是将多个物理设备和 VLAN 设备置于透明模式，并且进行分组的设备。`启用此设备的安全网关相当于一个二层交换机，但它同时可以过滤三层的内容。安全网关可以创建多个桥接设备，桥接设备绑定的物理设备或 VLAN 设备必须是启用并且工作在透明模式的设备。这些桥接设备可以和工作在路由模式下的物理设备和 VLAN 设备共存。`
    - VPN 设备：是启用 VPN 功能必须要启用的设备。`整个安全网关系统中只能有一个 VPN 设备，但是 VPN 设备的绑定设备可以选择。VPN 设备的 IP 地址、掩码与它的绑定设备的 IP 地址、掩码一致。`
    - 别名设备：用于给物理设备配置多个 IP 地址。`每个物理设备可以关联的别名设备是253个，同时要注意的是别名设备的 IP 地址不能重复。`
    - 冗余设备：是将多个物理设备捆绑在一起而成的虚拟设备。
    - 拨号设备：用于启用 ADSL 拨号功能所必须要启用的设备。`系统中只能有一个拨号设备，但是拨号设备绑定的物理设备可以选择。`
  - `配置安全网关的过程中，必须首先配置网络设备，再配置安全网关安全策略。`
  - 物理设备
    - `物理设备可以切换到透明模式。当桥接设备当中只有一个桥设备 brg0 时，切换到透明模式的物理设备会自动加入到桥接设备 brg0 中；如果把物理设备从透明模式切换到路由模式，系统自动将这个设备从桥接设备的设备列表中删除。`
    - `配置透明模式下的 TRUNK 功能时，请在“规则配置➡️包过滤规则➡️安全选项”页面，选中“802_2（4）“选项。`
  - VLAN 设备
    - `VLAN 设备是一种在物理设备基础上创建的设备。它可以工作在路由模式下，也可以工作在透明模式下，工作在透明模式下，此设备可加入桥接设备。VLAN 设备可以与其他同 VLAN 的设备通讯，并通过安全网关转发不同 VLAN 之间的通讯。`
    - `VLAN 设备和物理设备上的 TRUNK 属性是安全网关支持 VLAN 应用环境的两种方式。用户可以根据实际情况来选择使用何种方式，但两种方式不能同时使用。`
    - 设备的工作模式，目前支持的有以下两种
            1. 路由模式，这是设备默认的工作模式
            2. 透明模式，设置为透明模式的设备 IP 地址/掩码，不能用于管理，PING 和 TRACEROUTE 等选项也不能选择。
  - 桥接设备
    - `桥接设备是将多个工作在透明模式的物理设备和 VLAN 设备绑定在一起的设备。启用此设备的安全网关相当于一个二层交换机，但它同时可以过滤三层的内容。`
    - `安全网关可以创建多个桥接设备（最多可以创建八个桥接设备，设备名分别是brg0，brg1，brg2，brg3，brg4，brg5，brg6，brg7），而且这些桥接设备可以和工作在路由模式下的物理设备和 VLAN 设备共存。`
  - VPN 设备
    - VPN 设备是启用 VPN 功能所必须要启用的设备。`系统中最多可以支持 32 个 VPN 设备，每个 VPN 设备的绑定设备是不同的。每个 VPN 设备都可以启用带宽管理功能，但这要求它的绑定设备没有启用带宽管理。VPN 设备的 IP 地址、掩码与它的绑定设备的 IP 地址、掩码一致。`
  - 别名设备
    - 别名设备的作用是给物理设备配置多个 IP 地址。`每个物理设备可以关联的别名设备是 253 个`
    - 别名设备的总数不能超过 1024 个。
  - 冗余设备
    - 通过将几个物理设备捆绑在一起组成一个虚拟的冗余设备。冗余设备的作用有：
      - 提高链路可靠性。
      - 增加安全网关带宽。
  - 拨号设备
    - 拨号设备用于建立安全网关的 ADSL 连接，目前安全网关只能支持一个 ADSL 连接，它的设备名是 dial0。
  - 不同设备之间的配置关系
    ![网御安全网关PowerV不同网络设备之间的配置关系](https://i.imgur.com/tdaQxNv.png)
- 路由管理
  - 默认路由
    - 管理员可以添加、编辑或删除默认路由规则，同时可以开启、关闭对默认路由网关的实时监测功能。
    - `在设置默认路由时，请确保在 web 界面“网络配置➡️路由管理➡️静态路由”中没有设置默认网关，否则会导致配置冲突。`
    - `对默认路由的监控，系统会实时显示其监控信息，默认路由的监控页面在“状态监控➡️路由监控”页面中`
  - 静态路由
    - `安全网关的默认路由（默认路由即界面上的默认网关）也是在这里手工添加的，也可以删除，修改和启用，禁用默认路由。默认路由只能有一个生效。`
  - 动态路由
    - `网御安全网关的动态路由支持 OSPF 和 PIM-SM协议。OSPF 网络接口仅限制为物理设备（如 fe1 等）。`
    - OSPF
      - OSPF 配置比较复杂，需要以下5⃣️个步骤：
                1. 启动关闭 OSPF
                2. 配置路由器 ID 和重发布（可选）
                3. 标识区域分配，这里支持的路由器类型分为三种： regular、STUB、NSSA；OSPF 认证方式配置分为两个步骤：1）在区域配置中指定认证方式；2）在接口配置输入认证方式的密码，在后面介绍接口配置时将介绍配置认证密码详细内容
                4. 配置网络到指定区域
                5. 配置接口认证机制及计时
    - 多播路由
      - PIM-SM（Protocol Independent Multicast-Sparse Mode）配置需要3⃣️个步骤：
                6. 开启关闭 PIM-SM 服务
                7. 配置静态集合点 RP（Rendezvous Point）
                8. 配置多播接口
  - 策略路由
    - 网御安全网关提供策略路由功能，进行路由选择时不仅根据数据包的目的地址，而且可以根据数据包的源地址进行路由选择。`策略路由优先于静态路由生效。`
    - `策略路由的优先级高于静态路由，即数据包到达时，首先根据源地址匹配策略路由规则，如果找到匹配的规则，则根据规则进行策略路由，如果找不到，则进行静态路由。`
- 可用性管理
  - `网御安全网关支持双机热备，负载均衡和会话保护三种工作模式。`
  - `HA 在双机热备模式下，使用透明模式，桥设备的 STP 不能打开。HA 在双机热备模式下，不支持通过 DHCP 获得网口地址。`
  - HA 基本参数
  - HA 探测网口
  - HA 探测 IP
  - 端口同步
- 域名服务器
- UPnP 服务器
  - UPnP 服务的配置包括三部分内容：UPnP 接口设置，UPnP 规则维护和 UPnP 启动/停止。
    - UPnP 接口设置：设置 UPnP 服务使用的接口
    - UPnP 规则维护：添加、删除、修改可以使用 UPnP 的 IP 地址或地址段
    - UPnP 启动/停止：启动和停止 UPnP 服务
- DHCP 服务器

### 设备参数管理

- 日期时间
  - 可以采取2⃣️种方式来同步安全网关的系统时钟
        1. 与管理主机时间同步
        2. 与网络时钟服务器同步（NTP 协议）
- 系统参数
- 管理主机
  - `管理员只有在管理主机上才能对安全网关进行管理，最多支持 6 个管理主机 IP 和 1 个集中管理主机，至少有 1 个管理主机 IP 不能被删除。`
  - `安全网关出厂时有2⃣️个默认管理主机，10.1.5.200 和 10.1.5.49，10.1.5.49 是 PPP 接入管理主机。`
- 管理方式
  - `“启用远程 SSH”后，管理主机可以通过网络连接（通用网口或 PPP 连接均可），利用 secure crt 或 putty 等终端管理软件登录安全网关命令行界面进行管理。`

### 状态监控

- 连接统计
  - 连接状态
  - 连接统计
- 网络设备
- 用户信息
- 深度过滤
- 带宽监控
- 路由监控
  - `网御安全网关提供对多默认路由的状态监控。`
- OSPF 路由监控

### 维护工具

- 日志
- 网络测试
- 升级
- 导入导出
  - 导入导出界面包含以下功能
        1. 导出系统配置
        2. 导入系统配置
        3. 恢复出厂配置
        4. 保存配置
        5. 查看当前配置
- 账号管理
  - 管理员账号
  - 管理员证书
- 批处理工具

### 辅助功能

- 联动
  - IDS 产品
    - `当 IDS 联动产品发现入侵攻击行为时，会通知安全网关。安全网关会按 IDS 产品通知的阻断方式、阻断时间和入侵主机的相关信息，对入侵主机进行阻断。`
    - `安全网关阻断方式包括：`
      - 对“源 IP 地址”阻断
      - 对“源 IP 地址、目的 IP 地址、目的端口、协议”阻断
      - 对“源 IP 地址、目的 IP 地址、协议、方向（单向、双向、反向）”阻断
    - 安全网关阻断协议包括：`TCP/UDP/ICMP 和所有协议（any）`
  - 用户认证服务器
- 入侵检测

### VPN 配置

- 网御安全网关的 VPN 系统能提供“`IPSec`”、以及“`远程PPTP/L2TP（点对点隧道协议/第二层隧道协议）拨号`”、“`SSLVPN`”和“`GRE`”这四种形式的隧道。为了建立这四种隧道，提供如下界面管理：`自身 VPN 的基本配置`，`远程 VPN 的配置`，`网关-网关隧道配置`，`网关-客户端隧道配置`，`隧道监控和证书管理`。
  - 每次创建一条新的网关隧道或客户端隧道，都需要首先通过`VPN➡️IPSec➡️远程VPN`页面设定远程 VPN 的基本信息，包括`名称，认证方式，认证数据，类型，IKE 加密算法`等。
  - 随后根据新建 VPN 隧道的不同类型，分别在`网关隧道配置`、`客户端隧道配置`其中一个页面对新的隧道的`子网信息`、`IPSec 算法`、`数据包认证方式`等信息进行设置。
  - 最后在`VPN➡️IPSec➡️隧道监控`界面对新建的隧道进行启动操作，就可以马上启动新建立的隧道了。
  - 同时`VPN➡️隧道监控➡️PPTP隧道监控`界面，可以监控拨号用户建立的 VPN 隧道。
  - 如果在设置远程 VPN 时，`认证方式`设置为`证书`方式，就必须首先通过`证书管理`目录下的配置界面对 CA（认证中心）证书、本地证书、对方证书进行一系列的导入后，才可以建立使用证书方式进行认证的隧道。
  - 在`VPN➡️IPSec➡️基本配置`界面中包括了对自身 VPN 的基本设置，有 IPSec 协议的基本配置
  - 在`SSLVPN`的设置界面中包括了对 SSLVPN 的参数配置，SSLVPN 的用户管理，隧道监控，内网资源。
- IPSEC
  - 远程 VPN
  - 网关隧道配置
  - 客户端隧道配置
  - 基本配置
- L2TP/PPTP
  - 拨号用户
  - 参数配置
- GRE
- SSLVPN
  - 参数配置
  - 内网资源
  - 用户管理
- 证书管理
  - CA 证书
  - 对方证书
  - 本地证书：`密钥本地生成、密钥外部生成`
- 隧道监控
  - IPSec 隧道监控
  - PPTP 隧道监控
  - SSLVPN 隧道监控

## 功能使用手册

### VPN 概念与配置方法

- IPSec VPN 隧道
  - P13
- IKE 密钥交换
  - `IKE 密钥交换是建立 IPSec 隧道（IPSec SA）的协议。建立 IPSec 隧道是通过 IKE（Internet 密钥交换协议）完成的。`网御 VPN 支持用`预共享密钥`和`证书`两种认证方式的隧道建立方法。
    - 用`预共享密钥`建立隧道：`预共享密钥是通信双方预先知道的一个类似于口令的复杂字符串。因此此字符串只有通信双方知道，所以可以通过它完成互相的身份认证。`
    - 用`证书`建立隧道：`证书是利用非对称公钥密码学原理产生私钥对，然后将身份信息、公钥交付 CA 私钥签发。认证时，如果用证书中的公钥可以验证对方私钥的签名，那么对方的身份就可以确认是证书中所包含的身份。`
  - 建立一个 IPSec 隧道需要经过两个阶段的密钥协商。第一阶段建立一个验证的安全联盟和密钥，称为 `IKE SA`。随后可用 IKE SA 为 IPSec 安全协议建立安全联盟。这一阶段主要包含认证方式、身份信息交换（预共享密钥或证书）、算法、密钥、SA 生存期的协商。第二阶段建立一个用于 IPSec 的安全联盟，称为`IPSec SA`。第二阶段完成后，也就相当于 VPN 隧道建立完成，可以开始加密通信。第二阶段必须在第一阶段建立的 IKE SA 保护下进行。
    - `密钥协商第一阶段--建立 IKE SA 的过程`
      - 第一阶段主要包括`提案与密钥的交换`，最后建立一个 IKE SA。在这一阶段，有两种交换模式：`主模式`、`野蛮模式`。不管哪一种模式，他们都是交换提案，并协商一种双方都可以接受的安全属性。如`预共享密钥或证书的交换、加密认证算法、密钥、DH 组、IKE SA生存期。`
      - `主模式`由六个消息组成，发起者与响应者互相交互三次。首先发起者发起一个 SA 提案，包括`认证方式`、`加密认证算法`、`生存期`，响应者根据发起者的提案列表选择一个可以接受的提案。然后发起者发起一个密钥交换请求，`密钥交换使用 DH 算法完成`，响应者响应后双方就协商了一个密钥。然后开始一个身份交换，双方交换证书或 IP 地址身份信息。这样就完成了一个认证的 IKE SA。
      - `野蛮模式`由三条消息组成，交换两次就可以了。野蛮模式的第一条消息由 `SA 提案`、`密钥交换请求`、以及`ID 身份`组成。响应者选择可接受的 SA 提案，并响应协商密钥请求，认证身份。发起者然后根据响应者的返回消息，判断密钥是否生成成功，身份是否正确。如果确认后，那么发送正确的消息，这样就和主模式一样建立了一个认证的 `IKE SA`。
    - `密钥协商第二阶段`
      - 经过第一阶段，两个 VPN 之间建立了一个安全可信的信道。他们之间可以开始第二阶段密钥交换，`协商用于加密 VPN 通信的 IPSec SA`。`在第二阶段只有一种交换模式，快速模式，由三条消息组成。`与第一阶段类似，首先发起者发起由一些安全参数组成的提案，如 ESP 或 AH，IPSec SA 生存期，加密认证算法等，在第一个消息中还可以提起一个完美向前保密（PFS）请求，进行新的一个 DH 密钥交换，在第一个消息中还有身份信息，身份信息是指 IP 地址或子网信息。响应者首先选择一个可以接受的安全参数提案，如果发起消息中有 PFS 请求，那么就响应 DH 密钥交换，确定身份信息，也就是检查是否允许某两个 IP 地址或子网之间建立隧道。然后响应者将响应结果返回给发起者，发起者确认一切正确后，返回第三个消息确认。这样双方就完成了 IPSec SA 的建立，也就建立了隧道。
- VPN 虚拟接口设备配置方法
  - VPN 设备可以绑定物理设备、拨号设备、桥接设备。
- 局域网-局域网配置方法
  - 添加远程 VPN
    - `这里所设置的参数均为生成第一阶段 IKE SA 使用。`
    - `证书是设备身份的标志，它只与自身有关系，不需考虑对方的接入方式。`
  - 隧道配置方法
    - `这里所设置的参数均为生成第二阶段 IPSec SA 使用。`
    - `配置隧道时，如果使用默认参数时您可以只输入两端的保护子网信息。`
- VPN 客户端远程访问的配置方法
- 野蛮模式的应用
- 星型部署
- VPN 隧道与安全规则的关系
- PPTP/L2TP 远程访问 VPN 配置方法
- 动态域名配置方法
- SSLVPN
- 常见问题
- 网御 VPN CA 中心的使用方法
  - 证书管理
  - 使用第三方 CA 证书管理中心
  - CA 中心自身的管理
- GRE 隧道中继

### HA 概念与配置方法

- HA 和 LFRP 概述
- LFRP
  - LFRP 和网御安全网关的工作模式
    - LFRP V1.0 版本目前只适合支持路由模式，`桥模式只支持双机热备模式`，LFRP 在负载均衡下各安全网关节点的业务数据网口的物理 MAC 地址都为多播 MAC 地址，在双机热备模式下可设置为单播 MAC。
  - LFRP 自身的 HA 工作模式
    - LFRP 最多支持4⃣️个安全网关节点的 HA 集群，提供3⃣️种 HA 工作模式：
      - `主动-被动模式（双机热备）`：集群中所有节点的任意对应的业务网口 IP 和 MAC 地址都分别相同。`HA 在双机热备模式下，使用透明模式，桥设备的 STP 不能打开。`
      - `主动-主动模式（负载均衡）`：集群中所有节点的任意对应的业务网口 IP 和 MAC 地址都分别相同，各节点协同工作。
      - `会话保护模式`：本模式的各个安全网关分别独立工作，对应的业务口 IP 和 MAC 地址是不同的，节点的优先级也没有主从之分。
  - LFRP 集群的配置同步
    - LFRP 集群由一组（2-4台安全网关）实施相同的整体安全策略并且共享相同配置的网御安全网关设备组成。将一台网御安全网关设备新加入 LFRP 集群时，LFRP 集群中的主节点会对这台新加入的安全网关进行自动配置同步。如果在 LFRP 集群正常运转中，管理员对主安全网关节点配置进行了更改，主节点也会将任何发生的更改传播给其它所有从安全网关节点。这样保证了 LFRP 集群中的各安全网关节点保持相同的配置。`（注意：只有同一版本的安全网关才可以组成安全网关集群，否则会因为不同版本的配置格式导致同步配置出现异常）`
  - LFRP 集群的心跳协议（Heartbeat Protocol）
    - LFRP 集群中的各安全网关节点通过的 HA 网口进行心跳通讯，实时检测各安全网关的工作状态和动态控管整个安全网关集群。
    - 心跳协议在 `UDP 6666`端口进行通讯，整个 LFRP 集群有一个主节点和多个从节点：
      - 主节点周期性地（周期为0.5秒）广播自己的心跳信号给各从节点：
      - 从节点周期性地（周期为0.5秒）单播自己的心跳信号给主节点。
  - LFRP 集群的会话保护协议
  - LFRP 集群的路径监控
  - LFRP 集群的负载均衡技术
- 范例和配置
  - 范例一：单交换机节点下的主动-主动 LFRP 集群
    - P41
  - 范例二：双交换机节点下的主动-主动 LFRP 集群
    - P46
  - 范例三：双交换机双路由器（路由交换机）下的会话保护
    - P48
- 注意事项
  - `LFRP 集群的工作模式`
    - `LFRP 集群中的主动-主动模式只能是路由模式，不支持桥模式`
    - `LFRP 集群中的主动-被动模式支持路由模式和桥模式，但使用桥模式注意关闭安全网关上的 STP，且一定要将两个安全网关连接好心跳线后再接入网络中，否则易引起桥上的回环风暴。若出现回环风暴，只需重启其中任意一台安全网关即可解决。在路由模式下不会出现回环风暴，建议使用路由模式。`
    - `LFRP 的会话保护模式，支持路由模式和桥模式，使用时安全网关上的桥需要打开 STP。`

### 用户认证概念与配置方法

- 功能概述
  - 网御 Power V 的 IP 层用户认证系统解决了在应用代理一级做认证存在的这样三个问题：`只能为有限的服务提供认证功能`、`包处理的效率低`和`计费（流量或时间）的局限性`。其基本要点是：安全网关用户通过安全网关的身份认证后，安全网关将用户认证通过的结果传送到安全网关的访问控制部件模块，如：IP 层包过滤；安全网关可以对通过认证的用户进行各种协议、服务的访问控制。
- RADIUS 服务器的配置和安装
  - RADIUS 概述
    - RADIUS 是 Remote Access Dialin User Service 的简称，其用于对接入用户的身份认证，其任务包括认证（Authentication），即我能够允许你做些什么；授权（Authorization），即当你使用服务时，你做了些什么；计费（Accounting）。
    - `RADIUS 采用 UDP 封包为传输协议，标准认证端口为 1812，计费端口为 1813；老式标准的 RADIUS 认证端口为 1645，计费端口为 1646。`
  - RADIUS 服务器的配置
    - P69
    - 这里我们以目前功能最强大的 Open Source RADIUS 服务器软件 FreeRADIUS 为例来讲述如何配置 RADIUS 服务器。
- 用户认证和深度过滤的结合使用

### 冗余设备概念与配置方法

- 功能概述
  - `冗余设备是将多个物理设备捆绑在一起而成的虚拟设备。`冗余设备捆绑的物理设备共同完成收发工作，组成一个逻辑链路供系统使用。捆绑的物理设备可以相互备份，一个物理设备失效，其它物理设备可接替它的工作。
- 典型应用
  - 范例1-负载轮循方式
    - P76
  - 范例2-热备模式
    - P77

### 深度过滤概念与配置方法

- 基本概念
- 配置方法
  - 配置过程包括`启用深度过滤`、`设置服务端口`、`定义资源组`、`定义策略`、`在“规则配置”选择深度过滤策略`。如果是用户认证策略，还需要在`资源管理➡️用户资源➡️用户组`选择深度过滤策略。

### 典型应用环境

- 三网口纯路由模式
  - P87
    ![PowerV典型应用三网口纯路由模式](https://i.imgur.com/0LXqTbj.jpg)
- 三网口混合模式
  - P89
    ![PowerV典型应用三网口混合模式](https://i.imgur.com/tx877LF.jpg)
- 三网口透明模式
  - P91
    ![PowerV典型应用三网口透明模式](https://i.imgur.com/64H4kep.png)
- 三网口透明模式上的路由
  - P93
    ![PowerV典型应用三网口透明模式上的路由](https://i.imgur.com/U29f9rB.png)
- 三网口多 VLAN 环境
  - P95
    ![PowerV典型应用三网口多VLAN环境](https://i.imgur.com/9oPn6Wo.jpg)
- 多网口多 DMZ
  - P98
    ![Power V典型应用多网口多DMZ](https://i.imgur.com/8OBzJyd.jpg)
- 多网口多内网区段
  - P100
    ![PowerV典型应用多网口多内网区段](https://i.imgur.com/ZnpBwHZ.jpg)
- ADSL 连接
  - P103
    ![PowerV典型应用ADSL连接](https://i.imgur.com/X9KMSNy.png)
- 多默认路由负载均衡
  - P104
    ![PowerV典型应用多默认路由负载均衡](https://i.imgur.com/YCgzPhG.jpg)
- DHCP 的应用
  - P105
    ![PowerV典型应用DHCP的应用](https://i.imgur.com/7QE2hxK.png)
- 多外网出口
  - P107
    ![PowerV典型应用多外网出口](https://i.imgur.com/8PBrBSX.png)
- 端口映射应用
  - P109
    ![PowerV典型应用端口映射应用](https://i.imgur.com/orM2hQX.png)
- 连接企业分支的局域网-局域网 VPN 应用
  - P111
    ![PowerV典型应用连接企业分支的局域网-局域网VPN应用](https://i.imgur.com/zfEkTw8.jpg)
- 远程访问 VPN 客户端应用
  - P114
    ![PowerV典型应用远程访问VPN客户端应用](https://i.imgur.com/rIbqL0N.jpg)
- PPTP/L2TP 远程访问
  - P116
    ![PowerV典型应用PPTP:L2TP远程访问](https://i.imgur.com/r7Ml24g.png)
- 两组端口间连接状态同步（一）
  - P117
    ![PowerV典型应用两组端口间连接状态同步](https://i.imgur.com/4hQCz9M.png)
- 两组端口间连接状态同步（二）
  - P118
    ![PowerV典型应用两组端口间连接状态同步](https://i.imgur.com/4hQCz9M.png)
- OSPF 作为自治系统边界路由器，内部网络通过 NAT 访问自治系统
  - P119
    ![PowerV典型应用OSPF作为自治系统边界路由器内网通过NAT访问](https://i.imgur.com/NsBoJ35.png)
- 在 VLAN 网络环境应用 PIM-SM
  - P120
    ![PowerV典型应用在VLAN网络环境应用PIM-SM](https://i.imgur.com/Drf4PTD.png)

### FAQ

- IP 协议号列表
![PowerV_IP协议号列表](https://i.imgur.com/93PrjJ2.jpg)
